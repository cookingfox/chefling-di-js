!function(root,factory){"function"==typeof define&&define.amd?define([],function(){return root.Container=factory()}):"object"==typeof exports?module.exports=factory():root.Container=factory()}(this,function(){"use strict";function HashMap(){function indexOf(key){var i,len;for(i=0,len=_keys.length;len>i;++i)if(_keys[i]===key)return i}var _keys=[],_values=[];this.get=function(key){return _values[indexOf(key)]},this.getKeysForValue=function(value){var i,len,keys=[];for(i=0,len=_values.length;len>i;++i)_values[i]===value&&keys.push(_keys[i]);return keys},this.getValues=function(){return _values},this.has=function(key){return!!_values[indexOf(key)]},this.remove=function(key){var index=indexOf(key);delete _keys[index],delete _values[index]},this.set=function(key,value){var index=indexOf(key);void 0!==index?(_keys[index]=key,_values[index]=value):(_keys.push(key),_values.push(value))}}function Container(){function initialize(){_currentlyResolving=new Array,_instances=new HashMap,_mappings=new HashMap,_instances.set(Container,_self)}function addMapping(type,value){if(_self.has(type))throw new ContainerError("A mapping for `type` already exists");_mappings.set(type,value)}function createInstance(type){if(0===type.length)return new type;var factory,i,instance,len,param,args=[null],params=type.toString().match(FN_ARGS)[1].replace(STRIP_COMMENTS,"").replace(STRIP_WHITESPACE,"").split(",");for(i=0,len=params.length;len>i;++i){var paramName=params[i];paramName===Container.name?instance=_self:(param=asFunction(paramName),instance=_self.get(param)),args.push(instance)}return new(factory=type.bind.apply(type,args))}function resolveUsingFactory(type,factory){var instance=factory(_self);if(!instance)throw new ContainerError("Factory returned an empty value");if(!(instance instanceof type))throw new ContainerError("Factory returned an unexpected value");return instance}function lifeCycleDestroy(instance){instance&&instance.onDestroy&&instance.onDestroy()}function asFunction(value){if(isFunction(value))return value;if("string"!=typeof value)throw new ContainerError("Value is not a function and not a string, aka the name of the function");if(window&&isFunction(window[value]))return window[value];if(_loader)try{return _loader(value)}catch(e){throw new ContainerError("Loader error: "+(e instanceof Error?e.message:e))}throw new ContainerError("Value '"+value+"' ("+typeof value+") is not a function")}function isFunction(value){return value&&"function"==typeof value}function isSubType(type,subType){return type&&subType&&subType.prototype instanceof type}function isTypeOrInstance(type,value){return value===type||isSubType(type,value)||value instanceof type}function isValidType(value){var error=null,type=typeof value;if(value?isFunction(value)?value===Function?error="the base Function type":isTypeOrInstance(Error,value)?error="an Error type":isTypeOrInstance(Container,value)&&(error="a Container type"):error="not a function":error="empty",error){var valueName=value;throw value&&(valueName=Array.isArray(value)?"Array":value.name?value.name:type.charAt(0).toUpperCase()+type.slice(1)),new ContainerError("Type ["+valueName+"] is invalid, because it is "+error)}}var _currentlyResolving,_instances,_loader,_mappings,FN_ARGS=/^function[^\(]*\(([^\)]*)\)/m,STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,STRIP_WHITESPACE=/\s/gm,_self=this;initialize(),this.create=function(type){isValidType(type);var instance,mapping=_mappings.get(type);if(mapping?mapping instanceof type?instance=mapping:isFunction(mapping)&&(instance=isSubType(type,mapping)?_self.create(mapping):resolveUsingFactory(type,mapping)):instance=createInstance(type),!instance)throw new ContainerError("Could not create an instance for type "+type.name);return isFunction(instance.onCreate)&&instance.onCreate(),instance},this.get=function(type){var instance=_instances.get(type);if(instance)return instance;isValidType(type);var mapping=_mappings.get(type);if(isSubType(type,mapping))return _self.get(mapping);if(_currentlyResolving.indexOf(type)>=0)throw new ContainerError("Circular dependency detected: "+type.name);_currentlyResolving.push(type);try{instance=_self.create(type)}finally{_currentlyResolving.splice(_currentlyResolving.indexOf(type),1)}return _instances.set(type,instance),instance},this.has=function(type){return _instances.has(type)||_mappings.has(type)},this.mapFactory=function(type,factory){if(isValidType(type),!isFunction(factory))throw new ContainerError("Factory is not a function");addMapping(type,factory)},this.mapInstance=function(type,instance){if(isValidType(type),!instance||"object"!=typeof instance)throw new ContainerError("`instance` is not an object");if(!(instance instanceof type))throw new ContainerError("Value is not an instance of `type`");addMapping(type,instance)},this.mapType=function(type,subType){if(isValidType(type),!isFunction(subType))throw new ContainerError("`subType` is not a function");if(!isSubType(type,subType))throw new ContainerError("`subType` does not extend `type`");addMapping(type,subType)},this.remove=function(type){if(isValidType(type),type===Container)throw new ContainerError("Container instance can not be removed");lifeCycleDestroy(_instances.get(type)),_instances.remove(type),_mappings.remove(type);for(var toRemove=_mappings.getKeysForValue(type),i=0,len=toRemove.length;len>i;++i)_self.remove(toRemove[i])},this.reset=function(){for(var instances=_instances.getValues(),i=0,len=instances.length;len>i;++i)lifeCycleDestroy(instances[i]);_currentlyResolving=_instances=_mappings=null,initialize()},this.setLoader=function(loader){if(!isFunction(loader))throw new ContainerError("Loader is not a function");_loader=loader}}function ContainerError(message){this.message=message,Error.captureStackTrace?Error.captureStackTrace(this,ContainerError):this.stack=(new Error).stack||""}return Container.getDefault=function(){return Container.prototype._defaultInstance||(Container.prototype._defaultInstance=new Container),Container.prototype._defaultInstance},ContainerError.prototype=Object.create(Error.prototype),ContainerError.prototype.name="ContainerError",Container});